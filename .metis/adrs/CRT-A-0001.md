---
id: 001-css-to-shader-pipeline-architecture
level: adr
title: "CSS to Shader Pipeline Architecture"
number: 1
short_code: "CRT-A-0001"
created_at: 2025-11-25T02:11:52.318968+00:00
updated_at: 2025-11-25T02:12:48.111575+00:00
decision_date: 
decision_maker: 
parent: 
archived: false

tags:
  - "#adr"
  - "#phase/decided"


exit_criteria_met: false
strategy_id: NULL
initiative_id: NULL
---

# ADR-1: CSS to Shader Pipeline Architecture

## Status

**Decided** - 2025-11-25

## Context

CRT needs to apply GPU-based visual effects (scanlines, phosphor glow, screen curvature, etc.) to terminal content. Users should be able to configure these effects using a CSS-like syntax familiar to web developers.

Key requirements:
1. CSS-like property syntax for effect parameters (e.g., `--scanline-intensity: 0.3`)
2. Ability to enable/disable individual effects
3. Fast runtime parameter updates for animations/transitions
4. Reasonable shader compilation/switching overhead

Research conducted in initiative CRT-I-0001 explored three approaches through prototyping.

## Decision

**Adopt a hybrid approach combining shader generation with uniform-based parameters.**

Architecture:
1. **Shader Generation** (Prototype B style): Generate WGSL shader code based on which effects are enabled. Only include code for active effects.
2. **Uniform Parameters** (Prototype A style): Use uniform buffers for runtime parameter updates (intensity, colors, etc.) without shader recompilation.
3. **Lazy Regeneration**: Cache generated shaders. Only regenerate when the enabled effect set changes, not on parameter tweaks.

```
CSS Config                    
    |                         
    v                         
+-------------------+         +------------------+
| Effect Set        |---->    | Shader Generator |----> WGSL ----> Pipeline
| (which effects)   |         +------------------+       (cached)
+-------------------+         
    |                         
    v                         
+-------------------+         +------------------+
| Parameters        |---->    | Uniform Buffer   |----> GPU (every frame)
| (effect values)   |         +------------------+
+-------------------+         
```

## Alternatives Considered

| Option | Pros | Cons | Risk | Cost |
|--------|------|------|------|------|
| **A: Static Shader + Uniforms** | Simple, fast param updates, no regeneration | All effects compiled in, larger shader even when unused | Low | Low |
| **B: Full Shader Generation** | Minimal shaders, only needed code | Pipeline recreation on any config change | Medium | Medium |
| **C: Effect Graph (node-based)** | Visual editing, flexible composition | Complex implementation, overkill for fixed effect set | High | High |
| **Hybrid A+B (chosen)** | Best of both: minimal shaders + fast param updates | Slightly more complex than A alone | Low | Medium |

## Rationale

1. **Effect set is relatively stable**: Users typically pick a preset (classic, arcade, PVM) and tweak parameters. Effect enable/disable is infrequent.

2. **Parameter changes are frequent**: Brightness, contrast, scanline intensity change often (presets, animations, user adjustments).

3. **Shader size matters**: Including all effect code when most is disabled wastes GPU resources and complicates the shader.

4. **Pipeline creation is acceptable on config change**: Modern GPUs handle pipeline creation well. Caching generated shaders amortizes the cost.

## Consequences

### Positive
- Shaders only contain code for enabled effects (smaller, faster)
- Runtime parameter updates are a simple buffer write (fast)
- CSS-like API is straightforward to implement
- Presets map naturally to effect configurations

### Negative
- Two-level config system (effects vs parameters) adds complexity
- Need to track which config changes require shader regeneration
- Generated shader code is less readable than hand-written

### Neutral
- Shader caching strategy needed for production use
- May want to pre-generate common effect combinations

## Implementation Notes

Reference implementations:
- `examples/prototype_a.rs` - Uniform-based parameter updates
- `examples/prototype_b.rs` - Shader generation from config

Key types to implement:
- `CrtConfig` - CSS-like configuration struct
- `ShaderGenerator` - Produces WGSL from config
- `ShaderCache` - Caches generated shaders by effect set hash
- `CrtPipeline` - Manages shader/pipeline lifecycle