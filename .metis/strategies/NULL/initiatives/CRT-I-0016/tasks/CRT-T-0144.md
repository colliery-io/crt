---
id: add-opt-in-osc-133-shell
level: task
title: "Add opt-in OSC 133 shell integration for bash/zsh"
short_code: "CRT-T-0144"
created_at: 2025-12-29T18:52:10.364896+00:00
updated_at: 2025-12-29T18:52:10.364896+00:00
parent: CRT-I-0016
blocked_by: []
archived: false

tags:
  - "#task"
  - "#phase/todo"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0016
---

# Add opt-in OSC 133 shell integration for bash/zsh

**Phase 0** - Shell integration for command success/fail detection.

## Objective

Provide opt-in automatic OSC 133 injection for bash/zsh users who don't have starship or similar tools, enabling command success/fail events.

## Acceptance Criteria

- [ ] Config option `[shell] semantic_prompts = true` (default: false)
- [ ] Detect shell type from spawn command (bash/zsh/fish)
- [ ] Fish: No action (built-in OSC 133 since v3.4)
- [ ] Bash: Spawn with `--rcfile` pointing to CRT init script
- [ ] Zsh: Use ZDOTDIR or custom rcfile approach
- [ ] Init scripts source user's existing rc files first
- [ ] Init scripts add precmd/preexec hooks for OSC 133
- [ ] Redundant with starship/oh-my-zsh (harmless double-emission)

## Implementation Notes

### Config: `config.toml`

```toml
[shell]
semantic_prompts = true  # Enable automatic OSC 133 injection
```

### Files to Create

**`assets/shell/crt-bash-init`**:
```bash
[ -f ~/.bashrc ] && source ~/.bashrc

__crt_precmd() {
    printf '\e]133;D;%d\a' "$?"
}
PROMPT_COMMAND="__crt_precmd${PROMPT_COMMAND:+;$PROMPT_COMMAND}"
PS1='\[\e]133;A\a\]'"${PS1}"'\[\e]133;B\a\]'
```

**`assets/shell/crt-zsh-init`**:
```zsh
[ -f ~/.zshrc ] && source ~/.zshrc

__crt_precmd() { printf '\e]133;D;%d\a' "$?"; printf '\e]133;A\a' }
__crt_preexec() { printf '\e]133;B\a' }
autoload -Uz add-zsh-hook
add-zsh-hook precmd __crt_precmd
add-zsh-hook preexec __crt_preexec
```

### Shell Spawn Modification

```rust
if config.shell.semantic_prompts {
    match detect_shell(&command) {
        Shell::Bash => {
            args.push("--rcfile");
            args.push(crt_bash_init_path());
        }
        Shell::Zsh => {
            env.insert("ZDOTDIR", crt_zsh_config_dir());
        }
        Shell::Fish => { /* no-op, built-in support */ }
        _ => { /* unsupported shell, skip */ }
    }
}
```

### Dependencies
- CRT-T-0138 (OSC 133 parsing in crt-core)

### Note
This is Phase 0 and can be implemented independently. Users with starship or oh-my-zsh already have OSC 133 support.

## Status Updates

*To be added during implementation*