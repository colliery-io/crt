---
id: implement-vello-and-shader
level: task
title: "Implement vello and shader compositor"
short_code: "CRT-T-0048"
created_at: 2025-11-26T18:15:43.381389+00:00
updated_at: 2025-11-26T20:24:36.791769+00:00
parent: CRT-I-0009
blocked_by: []
archived: false

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0009
---

# Implement vello and shader compositor

*This template includes sections for various types of tasks. Delete sections that don't apply to your specific use case.*

## Parent Initiative **[CONDITIONAL: Assigned Task]**

[[CRT-I-0009]]

## Objective

Create a compositor that blends vello output, custom shader output (background grid, glow), and text layers into the final frame. This establishes the layered rendering architecture.

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

- [ ] Compositor blends multiple texture inputs
- [ ] Layer order: background -> vello UI -> glow effects -> text
- [ ] Alpha blending works correctly
- [ ] No visual regression from current rendering
- [ ] Clear separation between vello and shader content

## Implementation Notes

### Technical Approach

Create a compositor that combines:
1. Background shader output (gradient + grid)
2. vello texture (tab bar, future UI elements)
3. Composite/glow shader output (text glow)
4. Text layer (terminal glyphs)

### Render Order

```
1. Background shader -> background_texture
2. vello scene -> vello_texture  
3. Text to offscreen -> text_texture
4. Glow shader (text_texture) -> glow_texture
5. Compositor blends all -> screen
   - background_texture (opaque base)
   - vello_texture (alpha blend)
   - glow_texture (additive blend)
   - text direct (alpha blend)
```

### Code Sketch

```rust
pub struct Compositor {
    pipeline: wgpu::RenderPipeline,
    bind_group_layout: wgpu::BindGroupLayout,
}

impl Compositor {
    pub fn composite(
        &self,
        encoder: &mut wgpu::CommandEncoder,
        output: &wgpu::TextureView,
        background: &wgpu::TextureView,
        vello: &wgpu::TextureView,
        glow: &wgpu::TextureView,
    ) {
        // Single pass that samples all textures and blends
    }
}
```

### Shader Approach

```wgsl
@group(0) @binding(0) var background_tex: texture_2d<f32>;
@group(0) @binding(1) var vello_tex: texture_2d<f32>;
@group(0) @binding(2) var glow_tex: texture_2d<f32>;

@fragment
fn fs_main(in: VertexOutput) -> @location(0) vec4<f32> {
    let bg = textureSample(background_tex, sampler, in.uv);
    let ui = textureSample(vello_tex, sampler, in.uv);
    let glow = textureSample(glow_tex, sampler, in.uv);
    
    // Blend layers
    var color = bg.rgb;
    color = mix(color, ui.rgb, ui.a);  // UI over background
    color = color + glow.rgb * glow.a;  // Additive glow
    
    return vec4(color, 1.0);
}
```

### Dependencies

- CRT-T-0046 (vello setup)
- CRT-T-0047 (tab bar via vello)

### Files to Create/Modify

- `crates/crt-renderer/src/compositor.rs` (new)
- `crates/crt-renderer/src/shaders/compositor.wgsl` (new)
- `src/render.rs` - Use compositor in render pipeline

## Status Updates

*To be added during implementation*