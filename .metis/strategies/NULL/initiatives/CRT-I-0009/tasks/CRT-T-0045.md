---
id: integrate-lightningcss-and-replace
level: task
title: "Integrate lightningcss and replace crt-theme parser"
short_code: "CRT-T-0045"
created_at: 2025-11-26T18:15:41.660756+00:00
updated_at: 2025-11-26T18:15:41.660756+00:00
parent: CRT-I-0009
blocked_by: []
archived: false

tags:
  - "#task"
  - "#phase/todo"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0009
---

# Integrate lightningcss and replace crt-theme parser

## Parent Initiative

[[CRT-I-0009]] - CSS and 2D Rendering Foundation

## Objective

Replace the custom regex/string-based CSS parser in `crt-theme` with `lightningcss` for proper CSS parsing, enabling future support for `calc()`, `@keyframes`, color functions, and other CSS features.

## Acceptance Criteria

- [ ] `lightningcss` added as dependency to `crt-theme`
- [ ] New parser module using lightningcss StyleSheet API
- [ ] All existing custom properties (`--gradient-*`, `--glow-*`, etc.) still work
- [ ] CSS comments handled correctly
- [ ] Color functions like `rgba()`, `hsl()` parsed properly
- [ ] @keyframes rules can be extracted (prep for animations)
- [ ] Existing themes load without changes
- [ ] Unit tests for parser

## Implementation Notes

### Technical Approach

1. Add `lightningcss` to `crates/crt-theme/Cargo.toml`
2. Create `parser.rs` module with lightningcss-based parsing
3. Use `StyleSheet::parse()` to tokenize CSS
4. Walk rules to extract custom properties from `:root`
5. Convert parsed values to existing `Theme` struct fields
6. Keep existing `Theme` struct API unchanged (backward compat)

### Code Sketch

```rust
use lightningcss::stylesheet::{StyleSheet, ParserOptions};
use lightningcss::declaration::DeclarationBlock;

pub fn parse_theme_css(css: &str) -> Result<Theme, ParseError> {
    let stylesheet = StyleSheet::parse(css, ParserOptions::default())?;
    
    let mut theme = Theme::default();
    
    for rule in &stylesheet.rules.0 {
        if let CssRule::Style(style) = rule {
            // Check if selector is :root
            for decl in &style.declarations.declarations {
                if let Property::Custom(custom) = decl {
                    // Extract --gradient-top, --ansi-red, etc.
                    apply_custom_property(&mut theme, &custom.name, &custom.value);
                }
            }
        }
    }
    
    Ok(theme)
}
```

### Files to Modify

- `crates/crt-theme/Cargo.toml` - Add lightningcss dependency
- `crates/crt-theme/src/lib.rs` - Replace parser implementation
- `crates/crt-theme/src/parser.rs` (new) - lightningcss-based parser

### Dependencies

- None (first task in initiative)

## Status Updates

*To be added during implementation*