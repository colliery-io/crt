---
id: add-activeoverride-state-and-theme
level: task
title: "Add ActiveOverride state and theme compositor to renderer"
short_code: "CRT-T-0139"
created_at: 2025-12-29T18:52:01.065426+00:00
updated_at: 2025-12-29T19:22:13.796621+00:00
parent: CRT-I-0016
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0016
---

# Add ActiveOverride state and theme compositor to renderer

**Phase 4** - Core renderer integration for event-driven theming.

## Objective

Add runtime state to track active overrides and implement theme composition that applies overrides on top of base theme.

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

- [ ] `ActiveOverride` struct tracks current override + start time
- [ ] `trigger_event(event: TerminalEvent)` method on renderer
- [ ] Looks up EventOverride from theme based on event type
- [ ] Creates ActiveOverride with current timestamp
- [ ] `Theme::with_override()` computes effective theme values
- [ ] Each frame checks if override expired (duration elapsed)
- [ ] Clears ActiveOverride when expired
- [ ] `::on-blur` persists until FocusGained clears it
- [ ] New events replace current override (except blur is lower priority)

## Implementation Notes

### File: `crates/crt-renderer/src/effects/renderer.rs`

```rust
pub struct ActiveOverride {
    pub event_override: EventOverride,
    pub started_at: Instant,
    pub event_type: TerminalEvent,
}

impl EffectsRenderer {
    pub fn trigger_event(&mut self, event: TerminalEvent, theme: &Theme) {
        let override_opt = match event {
            TerminalEvent::Bell => theme.on_bell.as_ref(),
            TerminalEvent::CommandFail(_) => theme.on_command_fail.as_ref(),
            // etc.
        };
        if let Some(event_override) = override_opt {
            self.active_override = Some(ActiveOverride {
                event_override: event_override.clone(),
                started_at: Instant::now(),
                event_type: event,
            });
        }
    }
    
    pub fn effective_theme<'a>(&self, base: &'a Theme) -> Cow<'a, Theme> {
        // Apply override if active and not expired
    }
}
```

### Dependencies
- CRT-T-0136 (data structures)
- CRT-T-0137 (parser populates theme.on_* fields)

## Status Updates

*To be added during implementation*