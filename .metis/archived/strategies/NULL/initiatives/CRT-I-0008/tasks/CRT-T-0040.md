---
id: wire-ansi-palette-to-terminal-text
level: task
title: "Wire ANSI palette to terminal text rendering"
short_code: "CRT-T-0040"
created_at: 2025-11-26T17:50:52.431218+00:00
updated_at: 2025-11-26T20:45:10.526535+00:00
parent: CRT-I-0008
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0008
---

# Wire ANSI palette to terminal text rendering

## Parent Initiative

[[CRT-I-0008]] - Terminal Rendering Pipeline and ANSI Color Support

## Objective

Connect the parsed ANSI palette to the terminal text rendering pipeline, replacing hardcoded colors with theme-driven colors based on alacritty_terminal cell attributes.

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

- [ ] `AnsiPalette` passed through to `WindowState::update_text_buffer()`
- [ ] Map alacritty_terminal `Color` enum to palette colors
- [ ] Replace hardcoded `[0.9, 0.9, 0.9, 1.0]` with palette lookup
- [ ] Terminal text renders in correct ANSI colors
- [ ] `ls --color` output shows colored filenames

## Implementation Notes

### Technical Approach

1. Pass `AnsiPalette` reference to `update_text_buffer()` in `src/window.rs`
2. Extract foreground/background color from `cell.fg` and `cell.bg`
3. Create helper function to map `alacritty_terminal::term::color::Color` to `[f32; 4]`
4. Handle Named colors (Black, Red, Green, etc.) and indexed colors

### Color Mapping

```rust
fn ansi_to_rgba(color: &Color, palette: &AnsiPalette) -> [f32; 4] {
    match color {
        Color::Named(NamedColor::Black) => palette.black,
        Color::Named(NamedColor::Red) => palette.red,
        // ... etc
        Color::Named(NamedColor::BrightBlack) => palette.bright_black,
        // ... etc
        Color::Indexed(idx) => palette.indexed(*idx),
        Color::Spec(rgb) => [rgb.r as f32 / 255.0, rgb.g as f32 / 255.0, rgb.b as f32 / 255.0, 1.0],
    }
}
```

### Dependencies

- CRT-T-0039 (ANSI palette parsing) must be complete

### Files to Modify

- `src/window.rs` - Update `update_text_buffer()` to use palette
- `src/main.rs` - Pass palette through from theme

## Status Updates

### 2025-11-26: Completed

Implementation complete:

1. Added `ansi_color_to_rgba()` function to `src/window.rs` that maps:
   - All 16 named ANSI colors (Black-BrightWhite) via `NamedColor` enum
   - Dim variants to their base colors
   - Indexed colors 0-15 to palette, 16-231 to 216 color cube, 232-255 to grayscale
   - Spec (true color) RGB values directly

2. Added `NamedColor` re-export to `crates/crt-core/src/lib.rs`

3. Updated `update_text_buffer()` to:
   - Get palette from theme via `self.gpu.effect_pipeline.theme().palette`
   - Pass cell's foreground color through `ansi_color_to_rgba()` for each glyph

Terminal text now renders with correct ANSI colors from the theme palette.