---
id: wire-24-bit-true-color-spec
level: task
title: "Wire 24-bit true color (Spec variant) to renderer"
short_code: "CRT-T-0052"
created_at: 2025-11-26T21:26:31.638524+00:00
updated_at: 2025-11-27T00:06:40.689550+00:00
parent: CRT-I-0010
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0010
---

# Wire 24-bit true color (Spec variant) to renderer

## Parent Initiative
[[CRT-I-0010]]

## Objective
Verify and test that 24-bit true color (RGB) rendering works correctly. The `AnsiColor::Spec` variant is already handled in `ansi_color_to_rgba()`, but background colors are not rendered and the feature hasn't been tested.

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

- [ ] Foreground true color (SGR 38;2;R;G;B) renders correctly
- [ ] Background true color (SGR 48;2;R;G;B) renders correctly  
- [ ] Test with `true-color-test.sh` or similar color gradient script
- [ ] Verify colors match expected RGB values (no color space issues)
- [ ] Test in neovim/vim with true color themes

## Implementation Notes

### Current State
- `src/window.rs:81-86`: `AnsiColor::Spec` already converts RGB to float array
```rust
Spec(rgb) => [
    rgb.r as f32 / 255.0,
    rgb.g as f32 / 255.0,
    rgb.b as f32 / 255.0,
    1.0,
],
```
- Only foreground color (`cell.fg`) is used - background (`cell.bg`) is ignored
- No background color rendering exists in the pipeline

### Technical Approach

**1. Verify foreground true color works**
```bash
# Test script to verify true color
printf "\x1b[38;2;255;0;0mRed\x1b[0m "
printf "\x1b[38;2;0;255;0mGreen\x1b[0m "
printf "\x1b[38;2;0;0;255mBlue\x1b[0m\n"
```

**2. Add background color rendering**
```rust
// window.rs update_text_buffer()
for cell in content.display_iter {
    let x = offset_x + padding + (col as f32 * cell_width);
    let y = offset_y + padding + (row as f32 * line_height);
    
    // Render background if not default
    let bg_color = ansi_color_to_rgba(cell.bg, palette, default_bg);
    if bg_color != default_bg {
        terminal_vello.add_background_rect(x, y, cell_width, line_height, bg_color);
    }
    
    // Render foreground text (existing code)
    let fg_color = ansi_color_to_rgba(cell.fg, palette, default_fg);
    // ...
}
```

**3. Handle INVERSE flag**
```rust
// When INVERSE flag is set, swap fg/bg colors
let (fg, bg) = if cell.flags.contains(CellFlags::INVERSE) {
    (cell.bg, cell.fg)
} else {
    (cell.fg, cell.bg)
};
```

### Files to Modify
- `src/window.rs`: Add background color rendering, handle INVERSE flag
- `crates/crt-renderer/src/terminal_vello.rs`: Add `add_background_rect()` method

### Testing Commands
```bash
# True color gradient test
for i in $(seq 0 255); do
    printf "\x1b[48;2;$i;0;0m \x1b[0m"
done
echo

# Full 24-bit color test script
curl -s https://raw.githubusercontent.com/JohnMorales/dotfiles/master/colors/24-bit-color.sh | bash
```

### Dependencies
- vello for background rectangle rendering
- Selection highlighting needs to render above/blend with background colors

### Risk Considerations
- Background rendering order: backgrounds must render before text
- Selection highlighting interaction with cell backgrounds
- Performance: many background rects could slow rendering (batch into strips)

## Status Updates
*To be added during implementation*