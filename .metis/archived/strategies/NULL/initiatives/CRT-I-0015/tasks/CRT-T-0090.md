---
id: refactor-windowstate-to-use-new
level: task
title: "Refactor WindowState to use new state modules"
short_code: "CRT-T-0090"
created_at: 2025-11-28T14:51:30.371553+00:00
updated_at: 2025-11-28T15:45:16.127808+00:00
parent: CRT-I-0015
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0015
---

# Refactor WindowState to use new state modules

## Objective

Refactor `WindowState` to use the new state modules (`TabState`, `UiState`) instead of scattered fields, completing the Phase 1 state separation.

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

- [ ] `WindowState` uses `TabState` for tab management
- [ ] `WindowState` uses `UiState` for UI state
- [ ] Remove redundant fields from `WindowState`
- [ ] Update all call sites in `main.rs`, `input.rs`, `render.rs`
- [ ] All existing functionality preserved
- [ ] Application builds and runs correctly
- [ ] All existing tests pass

## Implementation Notes

### Before (current `window.rs`):

```rust
pub struct WindowState {
    pub window: Arc<Window>,
    pub gpu: WindowGpuState,
    pub shells: HashMap<u64, ShellTerminal>,
    pub active_tab_id: u64,
    pub tabs: Vec<TabInfo>,              // Remove
    pub next_tab_id: u64,                // Remove
    pub cursor_position: (f32, f32),     // Move to UiState
    pub detected_urls: Vec<DetectedUrl>, // Move to UiState
    pub hovered_url_index: Option<usize>,// Move to UiState
    pub search: SearchState,             // Move to UiState
    pub bell: BellState,                 // Move to UiState
    pub context_menu: ContextMenu,       // Move to UiState
    pub dirty: bool,                     // Move to UiState
    // ... other fields
}
```

### After (refactored):

```rust
use crate::state::{TabState, UiState, TabId};

pub struct WindowState {
    // Window and GPU (unchanged)
    pub window: Arc<Window>,
    pub gpu: WindowGpuState,
    
    // Terminal shells (unchanged)
    pub shells: HashMap<TabId, ShellTerminal>,
    
    // Extracted state modules
    pub tabs: TabState,
    pub ui: UiState,
    
    // Remaining window-specific state
    pub cols: usize,
    pub rows: usize,
    pub scale_factor: f32,
    pub font_scale: f32,
    pub content_hashes: HashMap<TabId, u64>,
    pub cached_render: CachedRenderState,
}
```

### Call Site Updates

**Tab operations** - change from direct field access to `TabState` methods:

```rust
// Before
state.tabs.push(TabInfo { id, title });
state.active_tab_id = id;

// After
let id = state.tabs.add_tab_and_activate(title);
```

**UI state** - access through `ui` field:

```rust
// Before
state.cursor_position = (x, y);
state.dirty = true;

// After
state.ui.cursor_position = (x, y);
state.ui.invalidate();
```

**Selection** - use `SelectionState` methods:

```rust
// Before (scattered logic)
state.selection_start = Some(point);
state.selecting = true;

// After
state.ui.selection.start(point, SelectionMode::Simple);
```

### Files to Update

1. `src/window.rs` - Refactor `WindowState` struct
2. `src/main.rs` - Update window creation and tab handling
3. `src/input.rs` - Update selection, search, context menu access
4. `src/render.rs` - Update dirty flag and UI state access

### Migration Strategy

1. Add new fields (`tabs: TabState`, `ui: UiState`) alongside old ones
2. Update all call sites to use new fields
3. Remove old fields once all usages are migrated
4. Run tests after each step

### Dependencies

- CRT-T-0087 (SelectionState)
- CRT-T-0088 (TabState)
- CRT-T-0089 (UiState)

### Risk Considerations

- This touches many files - commit intermediate steps
- Keep old fields during transition to avoid breaking builds
- Test tab switching, selection, and search after each major change