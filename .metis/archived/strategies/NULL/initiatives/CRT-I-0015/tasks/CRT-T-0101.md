---
id: add-effects-configuration
level: task
title: "Add effects configuration validation tests"
short_code: "CRT-T-0101"
created_at: 2025-11-28T14:51:56.521055+00:00
updated_at: 2025-11-29T17:20:05.317563+00:00
parent: CRT-I-0015
blocked_by: []
archived: true

tags:
  - "#task"
  - "#phase/completed"


exit_criteria_met: false
strategy_id: NULL
initiative_id: CRT-I-0015
---

# Add effects configuration validation tests

*This template includes sections for various types of tasks. Delete sections that don't apply to your specific use case.*

## Parent Initiative **[CONDITIONAL: Assigned Task]**

[[CRT-I-0015]]

## Objective

Add comprehensive validation tests for effect configuration parsing in `crt-theme`, ensuring CSS custom properties are correctly parsed and invalid values fall back to defaults.

## Backlog Item Details **[CONDITIONAL: Backlog Item]**

{Delete this section when task is assigned to an initiative}

### Type
- [ ] Bug - Production issue that needs fixing
- [ ] Feature - New functionality or enhancement  
- [ ] Tech Debt - Code improvement or refactoring
- [ ] Chore - Maintenance or setup work

### Priority
- [ ] P0 - Critical (blocks users/revenue)
- [ ] P1 - High (important for user experience)
- [ ] P2 - Medium (nice to have)
- [ ] P3 - Low (when time permits)

### Impact Assessment **[CONDITIONAL: Bug]**
- **Affected Users**: {Number/percentage of users affected}
- **Reproduction Steps**: 
  1. {Step 1}
  2. {Step 2}
  3. {Step 3}
- **Expected vs Actual**: {What should happen vs what happens}

### Business Justification **[CONDITIONAL: Feature]**
- **User Value**: {Why users need this}
- **Business Value**: {Impact on metrics/revenue}
- **Effort Estimate**: {Rough size - S/M/L/XL}

### Technical Debt Impact **[CONDITIONAL: Tech Debt]**
- **Current Problems**: {What's difficult/slow/buggy now}
- **Benefits of Fixing**: {What improves after refactoring}
- **Risk Assessment**: {Risks of not addressing this}

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

## Acceptance Criteria

- [ ] Tests for starfield effect config parsing
- [ ] Tests for rain effect config parsing  
- [ ] Tests for particle effect config parsing
- [ ] Tests for grid effect config parsing
- [ ] Tests for matrix effect config parsing
- [ ] Tests for invalid values using defaults
- [ ] Tests for missing properties using defaults
- [ ] All tests pass with `cargo test -p crt-theme`

## Test Cases **[CONDITIONAL: Testing Task]**

{Delete unless this is a testing task}

### Test Case 1: {Test Case Name}
- **Test ID**: TC-001
- **Preconditions**: {What must be true before testing}
- **Steps**: 
  1. {Step 1}
  2. {Step 2}
  3. {Step 3}
- **Expected Results**: {What should happen}
- **Actual Results**: {To be filled during execution}
- **Status**: {Pass/Fail/Blocked}

### Test Case 2: {Test Case Name}
- **Test ID**: TC-002
- **Preconditions**: {What must be true before testing}
- **Steps**: 
  1. {Step 1}
  2. {Step 2}
- **Expected Results**: {What should happen}
- **Actual Results**: {To be filled during execution}
- **Status**: {Pass/Fail/Blocked}

## Documentation Sections **[CONDITIONAL: Documentation Task]**

{Delete unless this is a documentation task}

### User Guide Content
- **Feature Description**: {What this feature does and why it's useful}
- **Prerequisites**: {What users need before using this feature}
- **Step-by-Step Instructions**:
  1. {Step 1 with screenshots/examples}
  2. {Step 2 with screenshots/examples}
  3. {Step 3 with screenshots/examples}

### Troubleshooting Guide
- **Common Issue 1**: {Problem description and solution}
- **Common Issue 2**: {Problem description and solution}
- **Error Messages**: {List of error messages and what they mean}

### API Documentation **[CONDITIONAL: API Documentation]**
- **Endpoint**: {API endpoint description}
- **Parameters**: {Required and optional parameters}
- **Example Request**: {Code example}
- **Example Response**: {Expected response format}

## Implementation Notes

### File: `crt-theme/src/lib.rs` (add to existing tests module)

```rust
#[cfg(test)]
mod effect_config_tests {
    use super::*;

    fn parse_theme_css(css: &str) -> Result<Theme, ParseError> {
        Theme::parse(css)
    }

    // Starfield tests
    
    #[test]
    fn test_starfield_enabled() {
        let css = r#"
            :terminal::backdrop {
                --starfield-enabled: true;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!(theme.effects.starfield.enabled);
    }

    #[test]
    fn test_starfield_density() {
        let css = r#"
            :terminal::backdrop {
                --starfield-enabled: true;
                --starfield-density: 200;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert_eq!(theme.effects.starfield.density, 200);
    }

    #[test]
    fn test_starfield_speed() {
        let css = r#"
            :terminal::backdrop {
                --starfield-enabled: true;
                --starfield-speed: 1.5;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!((theme.effects.starfield.speed - 1.5).abs() < 0.01);
    }

    // Rain tests
    
    #[test]
    fn test_rain_config() {
        let css = r#"
            :terminal::backdrop {
                --rain-enabled: true;
                --rain-density: 50;
                --rain-speed: 2.0;
                --rain-angle: 15;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!(theme.effects.rain.enabled);
        assert_eq!(theme.effects.rain.density, 50);
        assert!((theme.effects.rain.speed - 2.0).abs() < 0.01);
        assert_eq!(theme.effects.rain.angle, 15);
    }

    // Grid tests
    
    #[test]
    fn test_grid_config() {
        let css = r#"
            :terminal::backdrop {
                --grid-enabled: true;
                --grid-spacing: 40;
                --grid-perspective: 0.8;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!(theme.effects.grid.enabled);
        assert_eq!(theme.effects.grid.spacing, 40);
    }

    // Particle tests
    
    #[test]
    fn test_particle_shapes() {
        let css = r#"
            :terminal::backdrop {
                --particles-enabled: true;
                --particles-shape: heart;
                --particles-count: 30;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!(theme.effects.particles.enabled);
        assert_eq!(theme.effects.particles.shape, ParticleShape::Heart);
        assert_eq!(theme.effects.particles.count, 30);
    }

    // Matrix tests
    
    #[test]
    fn test_matrix_config() {
        let css = r#"
            :terminal::backdrop {
                --matrix-enabled: true;
                --matrix-density: 0.8;
                --matrix-speed: 1.2;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!(theme.effects.matrix.enabled);
    }

    // Default fallback tests
    
    #[test]
    fn test_missing_properties_use_defaults() {
        let css = r#"
            :terminal::backdrop {
                --starfield-enabled: true;
                /* density not specified */
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert_eq!(theme.effects.starfield.density, DEFAULT_STARFIELD_DENSITY);
    }

    #[test]
    fn test_invalid_density_uses_default() {
        let css = r#"
            :terminal::backdrop {
                --starfield-enabled: true;
                --starfield-density: -50;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        // Negative density should fall back to default
        assert!(theme.effects.starfield.density > 0);
    }

    #[test]
    fn test_invalid_speed_clamped() {
        let css = r#"
            :terminal::backdrop {
                --rain-enabled: true;
                --rain-speed: 100.0;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        // Extreme speed should be clamped to reasonable max
        assert!(theme.effects.rain.speed <= MAX_EFFECT_SPEED);
    }

    #[test]
    fn test_invalid_angle_clamped() {
        let css = r#"
            :terminal::backdrop {
                --rain-enabled: true;
                --rain-angle: 999;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        // Angle should be clamped to valid range
        assert!(theme.effects.rain.angle >= -90 && theme.effects.rain.angle <= 90);
    }

    #[test]
    fn test_disabled_by_default() {
        let css = r#"
            :terminal {
                background: #000;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        // All effects disabled when not specified
        assert!(!theme.effects.starfield.enabled);
        assert!(!theme.effects.rain.enabled);
        assert!(!theme.effects.grid.enabled);
        assert!(!theme.effects.particles.enabled);
        assert!(!theme.effects.matrix.enabled);
    }

    #[test]
    fn test_multiple_effects() {
        let css = r#"
            :terminal::backdrop {
                --starfield-enabled: true;
                --rain-enabled: true;
                --grid-enabled: false;
            }
        "#;
        let theme = parse_theme_css(css).unwrap();
        assert!(theme.effects.starfield.enabled);
        assert!(theme.effects.rain.enabled);
        assert!(!theme.effects.grid.enabled);
    }
}
```

### Dependencies

None - tests existing parsing code.

### Notes

- May need to add constants like `DEFAULT_STARFIELD_DENSITY`, `MAX_EFFECT_SPEED`
- Tests validate both parsing and value clamping/validation
- Run with `cargo test -p crt-theme effect_config_tests`